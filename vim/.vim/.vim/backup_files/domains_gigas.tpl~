{if $edit}
  {*<!-- TODO: Descomentame cuando seamos capaces de pintar esto con estilo
  <h1 class="domains2">{$lang.domdetails} {$details.name}</h1>
  <div class="cbreadcrumb">
    <a href="?/clientarea/">
      <strong>{$lang.clientarea}</strong>
    </a>
    &raquo; 
    <a href="?/clientarea/domains/">
      <strong>{$lang.domains}</strong>
    </a>

    {if $widget and $widget.name == "contactinfo" or $widget.name == "emailforwarding" or $widget.name=="dnsmanagement_widget"}
      &raquo;
      <a href="?/clientarea/domains/{$details.id}/{$details.name}/">
        <strong>{$details.name}</strong>
      </a> &raquo; 
      {if $lang[$widget.name]}
        {$lang[$widget.name]}
      {elseif $widget.fullname}
        {$widget.fullname}
      {else}
        {$widget.name}
      {/if} 
    {else}
      &raquo;
      <strong>{$details.name}</strong>
    {/if}
   </div>
   <br />
   -->*}
  {if $widget.appendtpl}
    {include file=$widget.appendtpl}
  {/if}
  {if $widget.replacetpl}
    {include file=$widget.replacetpl}
  {elseif $widget.name == "contactinfo" or $widget.name == "emailforwarding" or $widget.name=="dnsmanagement_widget"}
    {* Gestion de templates de widgets, ponemos la cabecera y los tabs, pero dejamos al widget hacer sus cosas *}
    <div id="domain-main-details">
      <div class="dom-head">
	<h2>
	  <img alt="dominios" src="{$template_dir}images/metal-dominios.png">
	  {$details.name}
	</h2>
      </div>
      <div class="tab-wrap">
        <div class="tabs">
	  <ul>
	    <li>
              <a id="domain-main-details-show"  href="?/clientarea/domains/{$details.id}/{$details.name}/">{$lang.domaindetails}</a>
            </li>
	    {foreach from=$widgets item=ewidget name=cst}
              {if $ewidget.name == "contactinfo" or $ewidget.name == "emailforwarding" or $ewidget.name == "dnsmanagement_widget"}
                <li>
                  <a 
                    {if $ewidget.name==$widget.name}
                      class="active" href="#tab"
                    {else}
                      href="?/clientarea/domains/{$details.id}/{$details.name}/&widget={$ewidget.name}" 
                    {/if}>
                    {if $ewidget.name=='emailforwarding'}
                      Email
                    {else}
                      {if $lang[$ewidget.name]}
                        {$lang[$ewidget.name]}
                      {elseif $ewidget.fullname}
                        {$ewidget.fullname}
                      {else}
                        {$ewidget.newname}
                      {/if}
                    {/if}
                </a>
                </li>
              {/if}
            {/foreach}
	  </ul>
            {assign var="widget_name" value=$widget.name}
            {include file="$template_path/domains/widgets/$widget_name.tpl"}
        </div>
  {else}
    {php}
        $domain_id = $this->get_template_vars('details')['id'];
        $gapi = new GApiWrapper();
        $is_invoice_gen_period = $gapi->isDomainInvoiceGenerationPeriod($domain_id);
        $this->assign('is_invoice_gen_period', $is_invoice_gen_period);
        $payment_module = $gapi->getDomainPaymentModule($domain_id);
        $payment_allow_autorenew = $payment_module !== false && ($payment_module['module'] == 'GigasAdyen' || $payment_module['module'] == 'GigasDomiciliacion');
        $this->assign('payment_allow_autorenew', $payment_allow_autorenew);
        $domain_order = $gapi->getDomainOrder($domain_id);
        if ($domain_order !== false && $domain_order['status'] == 'Pending') {
            $domain_invoice = $gapi->getOrderInvoice($domain_order['id']);
            $this->assign('invoice_paid_order_pending', $domain_invoice !== false && $domain_invoice['status'] == 'Paid');
        }
    {/php}
    <script type="text/javascript">
     {literal}
     function getRenewPeriods() {
       if($('.renewPeriods').hasClass('shown')) {
         $('.renewPeriods').hide().removeClass('shown');
       } else if($('.renewPeriods').hasClass('content_loaded')) {
         $('.renewPeriods').show().addClass('shown');
       } else {
         ajax_update('?cmd=clientarea&action=domains&getRenewPeriods={/literal}{$details.id}{literal}', {}, '.renewPeriods', true);
         $('.renewPeriods').show().addClass('shown').addClass('content_loaded');
       }
     }
     /**
      * Gestion de nameservers y child nameservers
      **/
     $(function(){
       var serversmine = new Array("","","","");
       var serversmine_ips = new Array("","","","");
       var serversexternal = new Array("","","","");

       function save_nameserver(ns_type, index, value) {
         if (value) {
             if(ns_type == 'mine') {
               serversmine[index] = value; //$(input).val();
             }
             else if(ns_type == 'clients') {
               serversexternal[index] = value;
             }
           }
       }

       function get_nameserver(ns_type, index) {
         var v = "dns0" + (index + 1) + ".gigas.com";
         if(ns_type== 'mine') {
           v = serversmine[index] || 'dns0' + (index + 1) + '.{/literal}{$details.name}{literal}';
         } else if (ns_type =='clients') {
           v = serversexternal[index];
         }
         return v;
       }

       var ns_type = $('input[name="whosns"]:checked').val();

       /**
        * inicializamos valores
        **/

       $('#nameform input[type="text"][name^="nameservers\["]').each(function(i,v)
                                                                     {
           if(ns_type == 'clients') {
             serversexternal[i] = $(v).val();
           }
           else if(ns_type == 'mine')
           {
             serversmine[i] = $(v).val();
             serversmine_ips[i] = $('#nameform input[type="text"][name="nsips\[nsip' + i + '\]"]').val();
           }
         });

       /**
        * cuando el usuario cambie el radiobutton
        **/

       $('#nameform input[name="whosns"]').change(function() {
         new_ns_type = $(this).val();
         //tratamos nsips
         $('#nameform input[type="text"][name^="nsips"]').each(function (e,v) {
           if(ns_type == "mine") {
             serversmine_ips[e] = $(v).val();
           }
           if(new_ns_type != 'mine') {
             $(v).val("");
             $(v).parent().fadeOut();
           } else {
             $(v).val(serversmine_ips[e]);
             $(v).parent().fadeIn();
           }
           });
           
         /**
          * tratamos nameservers
          **/
         $('#nameform input[type="text"][name^="nameservers\["]').each(function (i,v) {
           //save old values if proceeds
           save_nameserver(ns_type, i, $(v).val());
           //set new values
           $(v).val(get_nameserver(new_ns_type, i));
           $(v).attr('readonly', new_ns_type == 'ours');
         });
         ns_type = new_ns_type;
       });
     });
     {/literal}
    </script>
    <form action="" method="post">
      <input type="hidden" name="submit" value="1" />
      {if $custom}<div class="tabb">
	<center>
	  {foreach from=$custom item=btn}
            <input style="margin: 3px;display:none;" type="submit" name="regcommand[{$btn}]" value="{$lang.$btn}" class="padded" id="cbtn_{$btn}"/>
          {/foreach}
	</center>
      {/if}
      {securitytoken}
    </form>
    
    <div id="domain-main-details">
      <div class="dom-head">
	<h2>
	  <img alt="dominios" src="{$template_dir}images/metal-dominios.png">
	  {$details.name}
	</h2>
      </div>
      
      <div class="tab-wrap">
	<div class="tabs">
	  <ul>
	    <li><a id="domain-main-details-show" class="active" href="#tab">{$lang.domaindetails}</a></li>
	    {foreach from=$widgets item=ewidget name=cst}
              {if $ewidget.name == "contactinfo" or $ewidget.name == "emailforwarding" or $ewidget.name == "dnsmanagement_widget"}
                <li>
                  <a href="{$ca_url}clientarea/domains/{$details.id}/{$details.name}/&widget={$ewidget.name}">
                    {if $ewidget.name=='emailforwarding'}
                      Email
                    {else}
                      {if $lang[$ewidget.name]}
                        {$lang[$ewidget.name]}
                      {elseif $ewidget.fullname}
                        {$ewidget.fullname}
                      {else}
                        {$ewidget.newname}
                      {/if}
                    {/if}
                  </a>
                </li>
              {/if}
            {/foreach}
	  </ul>
	  <div class="formwrap fw2">
            {if (empty($clientdata.contact_id) || (!empty($clientdata.privileges.domains[$details.id]['ns'])))}
	    <form class="ts" id="nameform" method="post" action="?/clientarea/domains/{$details.id}/{$details.name}/&widget=nameservers">
	      <div class="tstitle">
		<h3>{$lang.nameservers}</h3>
	      </div>
	      <p class="domain-info">{$lang.nameservers_info}</p>
	      <div class="rd-nmserver">
                <div class="w-rd">
                  <input type="radio" name="whosns" value="ours" {if preg_match('/^dns0[0-9].gigas.com$/i', $details.nameservers[0])}checked{/if}/> {$lang.use_gigas_ns}<br />
                </div>
                <div class="w-rd">
                  <input type="radio" name="whosns" value="clients" {if !preg_match('/^dns0[0-9].gigas.com$/i', $details.nameservers[0]) && $details.nsips[0] == ""}checked{/if}/> {$lang.use_external_ns}<br />
                </div>
                {if (empty($clientdata.contact_id) || (!empty($clientdata.privileges.domains[$details.id]['registernameservers'])))}
                <div class="w-rd-l">
                  <input type="radio" name="whosns" value="mine" {if !preg_match('/^dns0[0-9].gigas.com$/i', $details.nameservers[0]) && $details.nsips[0] != ""}checked{/if}/> {$lang.use_own_ns}<br />
                </div>
                {/if}
	      </div>
              <input type="hidden" name="widgetdo" value="updateNameServers">
	      {section name=nameserver start=0 loop=4 step=1}
		{assign var="nsnumber" value=$smarty.section.nameserver.index}
		<div>
		  <label>{$lang.nameserver} {$smarty.section.nameserver.index+1}</label>
		  <input type="text" value="{$details.nameservers[$nsnumber]}" name="nameservers[ns{$smarty.section.nameserver.index+1}]" {if preg_match('/^dns0[0-9].gigas.com$/i', $details.nameservers[0])}readonly=""{/if}/>
		</div>
		<div {if preg_match('/^dns0[0-9].gigas.com$/i', $details.nameservers[0]) || (!preg_match('/^dns0[0-9].gigas.com$/i', $details.nameservers[0]) && $details.nsips[0] == "")}style="display:none"{/if}>
		  <label>{$lang.ipadd} {$smarty.section.nameserver.index+1}</label>
		  <input type="text" value="{$details.nsips[$nsnumber]}" name="nsips[nsip{$smarty.section.nameserver.index+1}]" ></input>
		</div>
	      {/section}
              <div>
                <input type="submit" name="save" value="{$lang.savechanges}" />
              </div>
              {securitytoken}
            </form>
            {/if}
            <div>
              {if (!preg_match("/\.es$/i", $details.name))}
                {if (empty($clientdata.contact_id) || (!empty($clientdata.privileges.domains[$details.id]['idprotection'])))}
                <div class="tstitle">
                  <h3>{$lang.privacity}</h3>
                </div>
                {$details|@var_dump}
                <p class="domain-info">{$lang.privacity_info}</p>
                
                <div class="mlp2 wrp-switch">
                  <label class="renew-label">{$lang.privacity}</label>
                  {if $details.idprotection == 0}
                    <strong><span class="auto-on">{$lang.On}</span></strong>
                    <a href="?/clientarea/domains/{$details.id}/{$details.name}/&widget=idprotection&widgetdo=updateIDProtection&idprotection=1&security_token={$security_token}"
                      id="privacy_pub_button"><strong><span class="auto-off">{$lang.Off}</span></strong></a>
                  {else}
                    <a href="?/clientarea/domains/{$details.id}/{$details.name}/&widget=idprotection&widgetdo=updateIDProtection&idprotection=0&security_token={$security_token}"
                      id="privacy_pri_button"><strong><span class="auto-off">{$lang.On}</span></strong></a>
                    <strong><span class="auto-on">{$lang.Off}</span></strong>
                  {/if}
                  <input type="hidden" id="privacyfield" name="nameservers[idprotection]" value="{$details.idprotection}" />
                </div>
                {/if}
                {* /if *}
                {* if (!preg_match("/\.es$/i", $details.name)) *}

                  <div class="tstitle">
                    <h3>{$lang.domain_lock}</h3>
                  </div>
                  <p class="domain-info">{$lang.domain_lock_info}</p>

                  <div class="mlp2 wrp-switch">
                    <label class="renew-label">{$lang.domain_lock_mini}</label>
                    {if $details.reglock==1}
                      <strong><span class="auto-on">{$lang.On}</span></strong>
                      <a href="?/clientarea/domains/{$details.id}/{$details.name}/&widget=reglock&widgetdo=updateRegistrarLock&updateRegistrarLock=0&security_token={$security_token}"
                         id="unlockbutton"><strong><span class="auto-off">{$lang.Off}</span></strong></a>
                    {else}
                      <a href="?/clientarea/domains/{$details.id}/{$details.name}/&widget=reglock&widgetdo=updateRegistrarLock&updateRegistrarLock=1&security_token={$security_token}"
                         id="lockbutton"><strong><span class="auto-off">{$lang.On}</span></strong></a>
                      <strong><span class="auto-on">{$lang.Off}</span></strong>
                    {/if}
                  </div>
              {/if}
            </div>
            {if (empty($clientdata.contact_id) || (!empty($clientdata.privileges.domains[$details.id]['renew'])))}
	    <form class="ts">
	      <div class="tstitle">
		<h3>{$lang.renewval}</h3>
	      </div>
	      <p class="domain-info">{$lang.renewval_info}</p>
              <p class="domain-info">
                {if $details.autorenew == 0}
                  {if $is_invoice_gen_period}
                    {$lang.renewval_bad_date}
                  {elseif !$payment_allow_autorenew}
                    {$lang.renewval_bad_payment}
                  {else}
                    {$lang.renewval_help}
                  {/if}
                {else}
                  {$lang.renewval_help}
                {/if}
              </p>
	      {*{if $details.status == 'Active' || $details.status == 'Expired'}*}
              <div class="renov">
                <p class="expiration">{$lang.expiration_date}: 
                  {if !$details.expires || $details.expires == '0000-00-00'}
                    <!--{$lang.none}--> --
                  {else}
                    {$details.expires|dateformat:$date_format}
                  {/if}
                </p>
                {if (empty($clientdata.contact_id) || (!empty($clientdata.privileges.domains[$details.id]['autorenew'])))}
                  {if $allowrenew}
                    <input style="margin: 3px" type="button" name="renew" value="{$lang.renewdomain}"  class="padded" onclick="window.location='?/clientarea/domains/renew/&ids[]={$details.id}'" id="renew-button" />
                  {/if}
                {/if}
                {if $details.daytoexpire < 60 && $details.daytoexpire >= 0}
                  <strong>{$details.daytoexpire}  {if $domain.daytoexpire==1}
                    {$lang.day}
                  {else}
                    {$lang.days}
                  {/if} {$lang.toexpire}</strong>{/if}
                  <br />
                  <span class="renewPeriods" style="display: none"></span>
              </div>
	      {*{/if}*}
	      {if $renewed}
                <h3>{$lang.renewdomain}:</h3>
                <h1 class="cart2">{$lang.order_ok}</h1>
                <p>{$lang.order_domain_thanks}</p>
                <h2>{$lang.order_num} {$order_num}</h2>
                <p>{$lang.order_domain_thanks2}</p>
              {/if}
              {securitytoken}
            </form>

            <script type="text/javascript">
             {literal}
             function set_field(name, value, form) {
               $("form[id="+ form +"] input[name=" + name+ "]").val(value);
               form=$("form[id="+ form +"]");
               // $.post(form.attr("action"), form.serialize()).success(function () {
               //   location.reload();
               // });
               $.post(form.attr("action"), form.serialize());
             }

             function confirm_set_field(name, value, form, confirm_text) {
               if (confirm(confirm_text)) {
                 set_field(name, value, form);
               }
             }
             {/literal}
            </script>

	      <div class="mlp2 wrp-switch {if $details.autorenew == 0 and ($is_invoice_gen_period or !$payment_allow_autorenew)}wrp-switch-disabled{/if}">
              <label class="renew-label">{$lang.autorenewval}</label>
             {if $details.autorenew==1}
                  <strong><span class="auto-on">{$lang.On}</span></strong>
                  <a
                  href="?/clientarea/domains/{$details.id}/{$details.name}/&widget=autorenew&make=setrenew&renew=0&security_token={$security_token}"
                  {if $invoice_paid_order_pending}
                    onclick="return function(){literal}{{/literal} alert('{$lang.renewval_off_pending|replace:"&#39;":"\'"}'); return false; {literal}}{/literal}();"
                  {else}
                    onclick="return confirm('{$lang.autorenewoff|replace:"&#39;":"\'"}');"
                  {/if}
                  >
                    <strong><span class="auto-off">{$lang.Off}</span></strong>
                  </a>
                {else}
                  <a
                  href="?/clientarea/domains/{$details.id}/{$details.name}/&widget=autorenew&make=setrenew&renew=1&security_token={$security_token}"
                  {if $is_invoice_gen_period}
                    onclick="return function(){literal}{{/literal} alert('{$lang.renewval_bad_date|replace:"&#39;":"\'"}'); return false; {literal}}{/literal}();"
                  {elseif !$payment_allow_autorenew}
                    onclick="return function(){literal}{{/literal} alert('{$lang.renewval_bad_payment|replace:"&#39;":"\'"}'); return false; {literal}}{/literal}();"
                  {/if}
                  >
                    <strong><span class="auto-off">{$lang.On}</span></strong>
                  </a>
                  <strong><span class="auto-on">{$lang.Off}</span></strong>
                {/if}

	      </div>
            <script src="{$template_dir}js/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
            <link rel="stylesheet" href="{$template_dir}js/fancybox/jquery.fancybox-1.3.4.css" type="text/css" media="screen" />
            <script>
            {literal}
            $(function(){
                $("#renew-terms-popup").fancybox({
                'width'				: '75%',
                'height'			: '75%',
                'autoScale'			: false,
                'transitionIn'		: 'none',
                'transitionOut'		: 'none',
                'type'				: 'iframe'
                });
            });
            {/literal}
            </script>
            <p id="domain-advise" class="domain-info">{$lang.renew_info1} <a id="renew-terms-popup" href="{$lang.langchange}/condiciones-dominios-popup.html" target="_bank">{$lang.legal}</a></p>
            {/if}
	    {* if !$details.name|strpos:".es" *}
            {if (!preg_match("/\.es$/i", $details.name))}
              {if (empty($clientdata.contact_id) || (!empty($clientdata.privileges.domains[$details.id]['eppcode'])))}
	      <form class="ts">
	        <div class="tstitle">
		  <h3>{$lang.authcode}</h3>
		</div>
		<p class="domain-info">{$lang.authcode_info}</p>
		<div class="auth-info mlp">
                  {php}
                  $m = ModuleFactory::getModule("Domain", "class.gigasreseller.php");
                  $eppCode = $m->getEppCode();                  
                  $this->assign('eppcode', $eppCode);
                  {/php}
                  <!--input class="auth-button" type="button" onclick="window.location='{$ca_url}clientarea/domains/{$details.id}/{$details.name}/&widget=eppcode'" value="{$lang.show}"-->
                  <input class="auth-button" type="button" onclick="$('span#eppcode').show(); $(this).hide();" value="{$lang.show}">
                  <span id="eppcode" style="display:none">{$eppcode|escape}</span>
		</div>
		{securitytoken}
	      </form>
              {/if}
	    {/if}
          </div>
        </div>
  {/if}
      </div><!--tabs-->
    </div><!--tab-wrap-->
{else}
    {if $domains}
    {php}
    # 
    # The pagination in Hostbill some times is broken, the ticket #7020 fixes
    # this problem until Hostbill upgrade
    #
    $totalpages = $this->get_template_vars('totalpages');
    $login = $this->get_template_vars('login');
    $ldomains = $this->get_template_vars('domains');
  
    if ($totalpages == 0) {
        $db = Engine::singleton()->getObject("db");
        $q = $db->prepare("SELECT value FROM hb_configuration WHERE setting = 'RecordsPerPage'");
        $q->execute();
        $items_x_page = intval($q->fetch(PDO::FETCH_OBJ)->value);
  
        if (count($ldomains) == $items_x_page) {
          $client_id = $login['id'];
          $q = $db->prepare("SELECT COUNT(*) AS count FROM hb_domains WHERE client_id = ?");
          $q->execute(array($client_id));
          $total_domains = intval($q->fetch(PDO::FETCH_OBJ)->count);
          $totalpages = ceil($total_domains / $items_x_page);
        } else {
          $totalpages = 1;
        }
        $q->closeCursor();
    }
    $this->assign('totalpages', $totalpages);
    {/php}

      <div class="paginacion-combo">
        <p class="xs">
          <span class="bef">{$lang.page}</span>
          <select name="page" id="currentpage" class="combo-xs">
            {section name=foo loop=$totalpages}
              <option value='{$smarty.section.foo.iteration-1}'>{$smarty.section.foo.iteration}</option>
            {/section}
          </select>
          {$lang.of}<span class="af"> {$totalpages}</span>
        </p>
      </div>
      
      <a href="{$ca_url}clientarea&amp;action=domains" id="currentlist" style="display:none" updater="#updater"></a>
      <div class="tablewrap">
	<h2>{$lang.domains|capitalize}</h2>
        <table>
	  <tr>
	    <th><a href="{$ca_url}clientarea/domains/&amp;orderby=date_created|ASC"  class="sortorder">{$lang.registrationdate}</a></th>
	    <th><a href="{$ca_url}clientarea/domains/&amp;orderby=name|ASC"  class="sortorder">{$lang.domain}</a></th>
	    <th><a href="{$ca_url}clientarea/domains/&amp;orderby=expires|ASC"  class="sortorder">{$lang.expirydate}</a></th>
        <th>{$lang.autorenew}</th>
	  </tr>
	  <tbody id="updater">
	    {include file='ajax.domains.tpl'}
	  </tbody>
	</table>
      </div>
      <div class="tablewrap">	
	<table>
	  <tr class="tdref">
	    <td></td>
	    <td></td>
	    <td class="Active">{$lang.Active}</td>
	    <td class="Pending">{$lang.Pending}</td>
	    <td class="Terminated">{$lang.Terminated}</td>
	    <td></td>
	    <td></td>
	  </tr>
	</table>
      </div>
    {else}
      {php}
      header("Location: index.php?/checkdomain/domain-registration/");
    {/php}
      {* {'?cmd=checkdomain'|string_format:$lang.nodomains} *}
    {/if}
{/if}

{*<pre>
  {php}
  print_r($this->get_template_vars());
{/php}*}
</pre>
