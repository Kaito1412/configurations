<?php
require_once(APPDIR_MODULES . 'Hosting/gigashosting/widgets/base_widget.php');


class widget_b_edit_vm extends base_widget
{
    protected $description = 'Allows clients to modify Cloud Server resources';
    protected $widgetfullname = 'Modify resources';

    public function b_edit_vm($details)
    {
        $vm = $this->user_api->get('/virtual_machine/' . $details['vpsid'])->json();
        if ($vm['locked']){
            $this->addError('The cloud server is locked by another task. Please try again later.|El cloud server está bloqueado por otra tarea. Por favor, inténtalo de nuevo más tarde.');
        }
        $this->template->assign('VMDetails', $vm);
        $tpl = $this->user_api->get('/template/' . $vm['template_id'])->json();
        $this->template->assign('min_memory_size', max(128, $tpl['min_memory_size']));
        $this->template->assign('max_cores', 100);
        $resources = $this->user_api->get_resources();
        $this->template->assign('resources', $resources);
    }

    public function b_edit_vm_editvm($details)
    {
        $vm = $this->user_api->get('/virtual_machine/' . $details['vpsid'])->json();
        $data = array();

        # cpu-type
        if (!empty($details['cpu-type']) and $vm['cpu_type'] != $details['cpu-type']) {
            $data['cpu_type'] = $details['cpu-type'];
        }

        # cpus
        if ($details['cpu-type'] == 'intel' and $vm['cpus'] != $details['EditVM']['cpus_intel']) {
            $data['cpus'] = $details['EditVM']['cpus_intel'];
        } elseif ($details['cpu-type'] != 'intel' and $vm['cpus'] != $details['EditVM']['cpus']) {
            $data['cpus'] = $details['EditVM']['cpus'];
        }

        # memory
        if ($vm['memory'] != $details['EditVM']['memory']) {
            $data['memory'] = $details['EditVM']['memory'];
        }

        if (!empty($data)) {
            try {
                $r = $this->user_api->put('/virtual_machine/' . $details['vpsid'], $data);
            } catch (Exception $r) {
            }
            $this->addError($r->content);
            if ($r->http_code == 200 or $r->http_code == 202) {
                $this->addInfo('Resource allocation has been modified. |La asignación de recursos ha sido modificada. ');
                if ($r->http_code == 202) {
                    $this->addInfo('Please wait while your Cloud Server is being rebooted. |Por favor espera hasta que tu Cloud Server se haya reiniciado. ');
                }
            } else {
                $this->addError('Resource allocation could not be modified. |La asignación de recursos no ha podido ser modificada. ');
            }
        }

        hbm_redirect('clientarea/services/' . $details['account']['slug'] . '/' . $details['account']['id'] . '/&vpsid=' . $details['vpsid'] . '&vpsdo=vmdetails');
    }
}
