{if $action=='add' || $action=='edit'}
  <section id="thestuff">
    <div class="tab-wrap">
      <div class="tabs">
        <ul>
          <li><a class="active" href="{$ca_url}profiles/">{$lang.profiles}</a></li>
          <li><a href="?cmd=gigasrol">{$lang.roles}</a></li>
        </ul>
      </div>
      <div class="formwrap w2">

        <h2>{$lang.profiles}{if $action=='add'}: {$lang.addnewprofile} {else}: {$submit.firstname} {$submit.lastname}{/if}</h2><br>
        <br>
        <br>



        <div class="cbreadcrumb">
          <a href="{$ca_url}clientarea/"><strong>{$lang.clientarea}</strong></a> &raquo;
          <a href="{$ca_url}profiles/"><strong>{$lang.profiles}</strong></a> &raquo;
          <strong>{if $action=='add'} {$lang.addnewprofile} {else} {$lang.profiledetails} {/if}</strong>
        </div>

        <br>
        <br>
        <div class="wbox_header wbox_users">{$lang.contactdetails}
        </div><br>
        <br>
        <form method="post" action="" >
          <input type="hidden" name="make" value="{if $action=='add'}addprofile{else}editprofile{/if}"/>
          <input type="hidden" name="security_token" value="{$security_token}"/>
          <input type="hidden" name="parent_id" value="{$login.id}"/>
          <input type="hidden" name="parent_mail" id="parent_mail" value="{$clientdata.email}"/>
          {if $action=="edit"}
            <input type="hidden" name="id" value="{$submit.client_id}"/>
          {/if}

          <div class="wbox">
            <div class="wbox_content">{include file=ajax.contact_signup.tpl}</div>
          </div>

          <div class="clear"></div>
          <!-- privilegios-->
          <div>
            <div class="centered-title"><div></div><span>{$lang.privileges}</span><div></div></div>
            <div class="wbox_inline-submenu">
              <span><b>{$lang.premadepriv}</b></span>
              <select name="roles" class="">
                <option value="0">{$lang.norole}</option>
              </select>
            </div>
            <div id="custom_privileges">
              <div class="clear"></div>
              <h2 style="float:none;">{$lang.common}</h2>
              <div class="privilegios">
                <div id="accordion-common">
                  <h3>
                  <span class="selector">
                  <input type="checkbox" class="privilege " id="billing_main" onclick="cUnc(this,'billing')"/>
                  <label class="common" for="billing_main" >{$lang.billing_main}</label>
                   </span>
                  </h3>

                  <div class="pgroup">
                    <table border="0" cellspacing="0" cellpadding="0" width="100%">
                      <tr>
                        <td width="33%">
                          <input type="checkbox" class="privilege billing" id="billing_orders" value="1" name="privileges[billing][orders]" {if $submit.privileges.billing.orders}checked="checked"{/if}  /> <label class="common" for="billing_orders"><div>{$lang.billing_orders}</div></label>
                        </td>
                        <td width="33%">
                          <input type="checkbox" class="privilege billing" id="billing_payinvoice" value="1" name="privileges[billing][payinvoice]"  {if $submit.privileges.billing.payinvoice}checked="checked"{/if} /> <label class="common" for="billing_payinvoice"><div>{$lang.billing_payinvoice}</div></label>
                        </td>
                        <td width="33%">
                          <input type="checkbox" class="privilege billing" id="billing_emails" value="1" name="privileges[billing][emails]" {if $submit.privileges.billing.emails}checked="checked"{/if} /> <label class="common" for="billing_emails"><div>{$lang.billing_emails}</div></label>
                        </td>
                      </tr> <tr>
                        <td width="33%">
                          <input type="checkbox" class="privilege billing" id="billing_balance"  value="1" name="privileges[billing][balance]" {if $submit.privileges.billing.balance}checked="checked"{/if}  /> <label class="common" for="billing_balance"><div>{$lang.billing_balance}</div></label>
                        </td>
                        <td width="33%">
                          {if $enableFeatures.deposit!='off' }<input type="checkbox" class="privilege billing" id="billing_addfunds" value="1" name="privileges[billing][addfunds]" {if $submit.privileges.billing.addfunds}checked="checked"{/if}  /> <label class="common" for="billing_addfunds"><div>{$lang.billing_addfunds}</div></label>{/if}
                        </td>
                        <td width="33%">
                        </td>
                      </tr>
                    </table>
                  </div>
                  {* eliminados ya que no se usa el soporte de hostbill
                  <h3>
                  <span class="selector">
                  <input type="checkbox" class="privilege " id="support_main" onclick="cUnc(this,'support')" /><label class="common" for="support_main" >{$lang.support_main}</label>
                  </span>
                  </h3>
                  <div class="pgroup">
                    <table border="0" cellspacing="0" cellpadding="0" width="100%">
                      <tr>
                        <td width="33%">
                          <input type="checkbox" class="privilege support" id="support_newticket"  value="1" name="privileges[support][newticket]" {if $submit.privileges.support.newticket}checked="checked"{/if}  /> <label class="common" for="support_newticket"><div>{$lang.support_newticket}</div></label>
                        </td>
                        <td width="33%">
                          <input type="checkbox" class="privilege support" id="support_tickets"  value="1"  name="privileges[support][tickets]" {if $submit.privileges.support.tickets}checked="checked"{/if}  /> <label class="common" for="support_tickets"><div>{$lang.support_tickets}</div></label>
                        </td>
                        <td width="33%">
                          <input type="checkbox" class="privilege support" id="support_closeticket"  value="1"  name="privileges[support][closeticket]" {if $submit.privileges.support.closeticket}checked="checked"{/if} /> <label class="common" for="support_closeticket"><div>{$lang.support_closeticket}</div></label>
                        </td>
                      </tr>  <tr>
                        <td width="33%">
                          <input type="checkbox" class="privilege support" id="support_emails"  value="1" name="privileges[support][emails]" {if $submit.privileges.support.emails}checked="checked"{/if}  /> <label class="common" for="support_emails"><div>{$lang.support_emails}</div></label>
                        </td>
                        <td width="33%">
                        </td>
                        <td width="33%">
                        </td>
                      </tr>
                    </table>
                  </div>
                  *}

                  <h3>
                  <span class="selector">
                  <input type="checkbox" class="privilege " id="misc_main" onclick="cUnc(this,'misc')" /><label class="common" for="misc_main" >{$lang.misc_main}</label>
                  </span>
                  </h3>
                  <div class="pgroup">
                    <table border="0" cellspacing="0" cellpadding="0" width="100%">
                      <tr>
                        <td width="33%">
                          <input type="checkbox" class="privilege misc " id="misc_manageprofiles" name="privileges[misc][manageprofiles]" value="1"  {if $submit.privileges.misc.manageprofiles}checked="checked"{/if} /> <label class="common" for="misc_manageprofiles"><div>{$lang.misc_manageprofiles}</div></label>
                        </td>
                        <td width="33%">
                          {if $services}
                            <input type="checkbox" class="privilege misc " id="services_full" name="privileges[services][full]" value="1"  {if $submit.privileges.services.full}checked="checked"{/if} onclick="{literal}if($(this).is(':checked')){$('[id^=accordion]').accordion({active:false});$('.priv_serv').slideUp();}else $('.priv_serv').slideDown(){/literal}"/> <label class="common" for="services_full" style="color:red"><div>{$lang.services_full}</div></label>
                          {/if}
                        </td>
                        <td width="33%">
                          {if $domains}
                            <input type="checkbox" class="privilege misc " id="domains_full" name="privileges[domains][full]" value="1"  {if $submit.privileges.domains.full}checked="checked"{/if} onclick="{literal}if($(this).is(':checked')){$('[id^=accordion]').accordion({active:false});$('.priv_dom').slideUp();}else $('.priv_dom').slideDown(){/literal}" /> <label class="common" for="domains_full" style="color:red"><div>{$lang.domains_full}</div></label>
                          {/if}
                        </td>
                      </tr>
                      <tr>
                        <td width="33%">
                          <input type="checkbox" class="privilege misc" id="misc_editmain" name="privileges[misc][editmain]"  value="1" {if $submit.privileges.misc.editmain}checked="checked"{/if} /> <label class="common" for="misc_editmain" style="color:red"><div>{$lang.misc_editmain}</div></label>
                        </td>
                        <td width="33%">
                          <input type="checkbox" class="privilege  misc" id="misc_emails" name="privileges[misc][emails]"  value="1" {if $submit.privileges.misc.emails}checked="checked"{/if} /> <label class="common" for="misc_emails"><div>{$lang.misc_emails}</div></label>
                        </td>
                        <td width="33%">
                          {if $enableFeatures.affiliates!='off'}<input type="checkbox" class="privilege misc " name="privileges[misc][affiliates]"  id="misc_affiliates" value="1"  {if $submit.privileges.misc.affiliates}checked="checked"{/if} /> <label class="common" for="misc_affiliates" ><div>{$lang.misc_affiliates}</div></label>{/if}
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>


              {php}
              $lang = $this->get_template_vars('lang');
              function translate_service_name($name, $lang)
              {
                  $slug_name = preg_replace('/[\W-]/', '-', strtolower($name));
                  return isset($lang[$slug_name]) ? $lang[$slug_name] : $name;
              }
              $services = $this->get_template_vars("services");
              $cat_services = array();
              foreach($services as $serv) {
                  $cat_name = translate_service_name($serv['catname'], $lang);
                  $cat_services[$cat_name][] = $serv;
              }
              $this->assign("cat_services", $cat_services);
              $general_permissions = array_map(
                  function ($x) { return array("widget"=> $x, "name" => $x, "fullname" => "services_$x");},
                  ["basic", "billing", "cancelation", "notify", "upgrade"]
              );
              {/php}

              {foreach from=$cat_services item=c_services key=cat_name}
                <h2 style="float:none;">{$cat_name}</h2>
                <div class="privilegios">
                  <div id="accordion-{$catq_name}">
                    {foreach from=$c_services item=o}
                        {php}
                            $o = $this->get_template_vars()['o'];
                            $o['name'] = translate_service_name($o['name'], $lang);
                            $this->assign('o', $o);
                        {/php}

                      <h3 class="priv_serv" {if $submit.privileges.services.full}style="display:none"{/if}>
                        <span class="selector">
                          <input type="checkbox" class="privilege " id="smain_{$o.id}" onclick="cUnc(this,'s{$o.id}')" />
                          <label class="common" for="smain_{$o.id}">{$cat_name} {if $o.name != "Backup_advanced"}- {$o.name} {/if}{if $o.domain}<em>({$o.domain})</em>{/if}</label>
                        </span>
                      </h3>
                      <div class="pgroup" {if $submit.privileges.services.full}style="display:none"{/if}>
                        <table border="0" cellspacing="0" cellpadding="0" width="100%">

                            {php}
                            $o = $this->get_template_vars("o");
                            $widgets= array_merge($o['widgets'], $general_permissions);
                            $desc_widget = array();
                            foreach ($widgets as $key=>$wid) {
                              $desc_widget[$key] = ($lang[$wid['name']] ? $lang[$wid['name']] : ($lang[$wid['fullname']] ? $lang[$wid['fullname']] : $wid['fullname']));
                            }
                            array_multisort($desc_widget, SORT_ASC, $widgets);
                            $this->assign("current_widgets", $widgets);
                            {/php}
                            {foreach from=$current_widgets item=w name=wl}
                              {if $smarty.foreach.wl.index%3=='0'}<tr>{/if}
                                <td width="33%">
                                  <input type="checkbox" class="privilege s{$o.id} services" id="services_{$o.id}_{$w.name}" value="1" name="privileges[services][{$o.id}][{$w.name}]" {if $submit.privileges.services[$o.id][$w.name]}checked="checked"{/if}/> <label class="common" for="services_{$o.id}_{$w.name}"><div>{if $lang[$w.name]}{$lang[$w.name]}{elseif $lang[$w.fullname]}{$lang[$w.fullname]}{elseif $w.fullname}{$w.fullname}{else}{$w.name}{/if}</div></label>
                                </td>
                                {if $smarty.foreach.wl.index%3=='5'}</tr>{/if}
                            {/foreach}

                        </table>
                      </div>

                    {/foreach}
                  </div>
                </div>
              {/foreach}

              {if $domains}
                <h2 style="float:none;">{$lang.domains|capitalize}</h2>
                <div class="privilegios">
                  <div id="accordion-{$cat_name}" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons" role="tablist">
                    {foreach from=$domains item=o}
                      <h3 class="priv_dom" {if $submit.privileges.domains.full}style="display:none"{/if}>
                      <span class="selector">
                      <input type="checkbox" class="privilege " id="dmain_{$o.id}" onclick="cUnc(this,'d{$o.id}')" /> <label class="common" for="dmain_{$o.id}">{$lang.domain} - {$o.name}</label>
                      </span>
                      </h3>
                      <div class="pgroup" {if $submit.privileges.domains.full}style="display:none"{/if}>
                        <table border="0" cellspacing="0" cellpadding="0" width="100%">
                          <tr>
                            <td width="33%">
                              <input type="checkbox" class="privilege d{$o.id} domains" id="domains_{$o.id}_ns" value="1" name="privileges[domains][{$o.id}][ns]" {if $submit.privileges.domains[$o.id].ns}checked="checked"{/if}/> <label class="common" for="domains_{$o.id}_ns"><div>{$lang.domains_ns}</div></label>
                            </td>
                            <td width="33%">
                              <input type="checkbox" class="privilege  d{$o.id} domains" id="domains_{$o.id}_renew" value="1"  name="privileges[domains][{$o.id}][renew]" {if $submit.privileges.domains[$o.id].renew}checked="checked"{/if}/> <label class="common" for="domains_{$o.id}_renew"><div>{$lang.domains_renew}</div></label>
                            </td>
                            <td width="33%">
                              <input type="checkbox" class="privilege  d{$o.id} domains" id="domains_{$o.id}_notify" value="1"  name="privileges[domains][{$o.id}][notify]" {if $submit.privileges.domains[$o.id].notify}checked="checked"{/if}/> <label class="common" for="domains_{$o.id}_notify"><div>{$lang.services_notify}</div></label>

                            </td>
                          </tr>
                          <tr>
                            <td width="33%">
                              <input type="checkbox" class="privilege d{$o.id} domains" id="domains_{$o.id}_basic" value="1" name="privileges[domains][{$o.id}][basic]" {if $submit.privileges.domains[$o.id].basic}checked="checked"{/if}/> <label class="common" for="domains_{$o.id}_basic"><div>{$lang.domains_basic}</div></label>
                            </td>
                            <td width="33%">
                            </td>
                            <td width="33%">

                            </td>
                          </tr>
                        </table>
                      </div>
                    {/foreach}
                  </div>
                </div>
              {/if}
            </div>
          </div>

          <script>
           {literal}

           function cUnc(el,target) {
             if($(el).is(':checked')) {
               $('.'+target).attr('checked','checked');
             } else {
               $('.'+target).removeAttr('checked');

             }
           }

           function loadProfile(val) {
             $('.privilege').removeAttr('checked');
             $('#priv_dom').show();
             $('#priv_serv').show();
             if(val==0) {
               return false;
             }
             $.post('?cmd=profiles&action=loadpremade',{premade:val},function(response){
               if(response.all) {
                 $('.privilege').attr('checked','checked'); return;
               }
               if(response.billing) {
                 if(response.billing.all) {
                   $('.billing').attr('checked','checked');
                 }
               }if(response.domains) {
                 if(response.domains.all) {
                   $('.domains').attr('checked','checked');
                 }
               }if(response.services) {
                 if(response.services.all) {
                   $('.services').attr('checked','checked');
                 }
               }if(response.support) {
                 if(response.support.all) {
                   $('.support').attr('checked','checked');
                 }
               }
             });

             return false;
           }

           $(function() {
             $("[id^=accordion]").accordion({
               collapsible: true, autoHeight: false,
               active: false
             });
             $('[id^=accordion] h3 span.selector').click(function(e) {
               e.stopPropagation();
               $(this).find("label").removeClass("partial");
             });
             function mark_group(some_checkbox, correction) {
               correction = typeof correction !== 'undefined' ? correction : 0; //default parameter = 0
               var group = some_checkbox.parents(".pgroup");
               var num_checkbox = group.find("tr input").length;
               var marked_checkbox = group.find("tr input:checked").length + correction;
               group.prev().find("input").prop('checked', (num_checkbox > 0 && num_checkbox == marked_checkbox));
               if (marked_checkbox > 0 && num_checkbox != marked_checkbox) {
                 group.prev().find("label").addClass("partial");
               } else {
                 group.prev().find("label").removeClass("partial");
               }
             }
             {/literal}
             {if (!$readonly)}
             {literal}
             $('input[name^=privileges] + label').click(function (e) {
               var checkbox = $("#" + $(this).attr("for"));
               if (typeof(checkbox[0]) !== "undefined") {
                 var correction = checkbox[0].checked ? -1 : 1; //clicking on a label happens before toggling the associated checbox
                 mark_group(checkbox, correction);
               }
             });
             {/literal}
             {/if}
             {literal}
             //first pass to adjust
             $('.pgroup').each(function (i, e) { mark_group($(e).find('input').first());});

             var select_roles = $('select[name=roles]');
             var client = {/literal}{$clientdata.id}{literal};
             var contact = {/literal}{if ($submit.client_id) }{$submit.client_id}{else}""{/if}{literal};

           $("form").attr("action", "?cmd=gigasrol&action={/literal}{$action}{literal}Profile");
           $("form").unbind("submit"); // clear previous handlers, just in case           
           select_roles.change(function() {
               if ($(this).val() == 0) {
                 $("div#custom_privileges").show();
                 if (typeof($("input[name=id]").val()) != "undefined") {
                   $("form").bind("submit", function(e) {
                     e.preventDefault();
                     $.get("?cmd=gigasrol&action=remove_role",
                           {id: contact},
                           function (data) {
                         if (!data.result) {
                           addMessage("There was an error with your request|Hubo un error con tu petición", "error");
                         } else {
                           e.target.submit();
                         }
                       } );
                   });
                 }
               } else {
                 $("div#custom_privileges").hide();
                 $("form").attr("action", "?cmd=gigasrol&action={/literal}{$action}{literal}Profile");
                 $("form").unbind("submit");
               }
             });

             $.get("?cmd=gigasrol&action=roles&client=" + client + "&contact=" + contact,
                   null,
                   function (data) {
                 if (typeof(data['roles']) != "undefined") {
                   var role_list = data['roles'];
                   for(var i = 0; i<role_list.length; i++) {
                     var selected = role_list[i]['id'] == data['current_rol'];
                     select_roles.append(new Option(role_list[i]['name'], role_list[i]['id'], selected, selected));
                   }

                   if (typeof(data['current_rol'] != "undefined") && data['current_rol'] != 0 && data['current_rol'] != null) {
                     $("div#custom_privileges").hide();
                     $("form").attr("action", "?cmd=gigasrol&action={/literal}{$action}{literal}Profile");
                   } else if (data['current_rol']==0 || data['current_rol'] == null) {
                     select_roles.find("option[value=0]").prop('selected', true);
                   }
                 }
                 select_roles.change();
               });
           });

           {/literal}
          </script>


          <div style="clear:both; margin-top:15px;">
            <input type="submit" value="{$lang.submit}" style="font-weight:bold;margin:5px;" class="padded" id="bt_submit" />
          </div>
          <!-- fin de privilegios-->
        </form>
      </div>
    </div>
  </section>


{else}
  {php}
  // Load the contacts list
  $gr = new gigasrol();
  $profiles = $gr->getClientContacts($_SESSION['AppSettings']['login']['id']);
  $this->assign("profiles", $profiles);
  {/php}
  <section id="thestuff">
    <div class="tab-wrap">


      <div class="tabs">
        <ul>
          <li><a  class="active" href="{$ca_url}profiles/">{$lang.profiles}</a></li>
          <li><a href="?cmd=gigasrol">{$lang.roles}</a></li>
        </ul>
      </div>

      <div class="formwrap w2">
        <h2>{$lang.profiles}</h2><br /> <br /><br /><br />
        <p>{$lang.profileinfo}</p>
        <div class="wbox">
       		<div>
              <div class="wbox_header wbox_users"><h3>{$lang.currentprofiles}</h3> </div>
              <div class="wbox_submenu">
                <a class="button-add" href="{$ca_url}profiles/add/">+ {$lang.addnewprofile}</a>
              </div>
              <div class="clear"></div>
             </div>
          <div class="clear">
            {if $profiles}

              <table width="100%" cellspacing="0" cellpadding="0" border="0" class="styled">
                <colgroup class="firstcol"></colgroup>
                <colgroup class="alternatecol"></colgroup>
                <colgroup class="firstcol"></colgroup>
                <colgroup class="alternatecol"></colgroup>
                <colgroup class="firstcol"></colgroup>
                <tbody>
                  <tr>
                    <th align="left">{$lang.firstname}</th>
                    <th>{$lang.lastname}</th>
                    <th>{$lang.email}</th>
                    <th width="90px">{$lang.lastlogin}</th>
                    <th width="110px">{$lang.roles}</th>
                    <th width="40"></th>
                  </tr>
                </tbody>
                <tbody id="updater">
                  {foreach from=$profiles item=p name=ff}
                    <tr class="{if $smarty.foreach.ff.index%2==0}even{/if}">
                      <td><a href="{$ca_url}profiles/edit/{$p.id}/">{$p.firstname}</a></td>
                      <td align="center"><a href="{$ca_url}profiles/edit/{$p.id}/">{$p.lastname}</a></td>
                      <td align="center"><a href="{$ca_url}profiles/edit/{$p.id}/">{$p.email}</a></td>
                      <td align="center">{if !$p.lastlogin|dateformat:$date_format}-{else}{$p.lastlogin|dateformat:$date_format}{/if}</td>
                      <td>{if ($p.role_id != 0)}<a href="?cmd=gigasrol&action=view&id={$p.role_id}">{$p.role_name}</a>{else}{$lang.norole}{/if}</td>
                      <td>
                        <a href="?cmd=gigasrol&action=delete_contact&id={$p.id}" onclick="return confirm('{$lang.areyousuredelete}');" class="deleteico">{$lang.delete}</a>
                      </td>
                    </tr>
                  {/foreach}
                </tbody>
              </table>
            {else}
              {$lang.nothing}
            {/if}

          </div>


        </div>
      </div>
    </div>
  </section>

{/if}
