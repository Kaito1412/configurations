'use strict';

var express = require('express');
var path = require('path');
var session = require('express-session');
var cookieParser = require('cookie-parser');
var bodyParser = require('body-parser');
var methodOverride = require('method-override');
var favicon = require('serve-favicon');
var i18n = require('i18next');
var lessMiddleware = require('less-middleware');

var logger = require('./lib/logger');
var config = require('./config');

var app = express();

//Middleware
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'jade');
app.use(i18n.handle);
app.use(cookieParser());
app.use(bodyParser.urlencoded({extended: false}));
app.use(bodyParser.json());
app.use(methodOverride());
app.use(session({secret : 'jiojfkvifos', cookie: {maxAge: 6000000}}));
app.use(function(req, res, next) {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
  next();
});

app.use(lessMiddleware('./', {
  dest: path.join(__dirname),
  options: {
    compiler: {
      compress: true
    }
  },
  preprocess: {
    path: function(pathname) {
      return pathname.replace('css', 'less');
    }
  },
  debug: false,
  force: true
}));

//i18n
i18n.init({ lng: 'en' });
i18n.registerAppHelper(app);

//routes
require('./routes')(app);
var callsCtl = require('./controllers/callsCtrl');
var dashCtrl = require('./controllers/dashCtl');
var usersCtrl = require('./controllers/usersCtrl');
var routeAPI = express.Router();

routeAPI.route('/calls')
  .get(callsCtl.findAllCalls)
  .post(callsCtl.addCall);
routeAPI.route('/dashboard')
  .get(dashCtrl.calcAll)
  .post(dashCtrl.calcWeek);
routeAPI.route('/users')
  .get(usersCtrl.findAllUsers)
  .post(usersCtrl.addUser)
  .delete(usersCtrl.delUser)
  .put(usersCtrl.updateUser);
routeAPI.route('/extensions')
  .get(usersCtrl.findExtensions);

app.use('/api', routeAPI);
app.use('/audio', express.static(__dirname + '/audio'));
app.use('/public', express.static(__dirname + '/public'));
app.use('/locales', express.static(__dirname + '/locales'));
app.use(favicon(__dirname + '/public/images/logo.png'));

app.listen(config.port);
logger.log('info', 'Submit GET or POST to http://localhost:' + config.port);
